<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Open RouteThis</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 24px; line-height: 1.4; }
    button { font-size: 16px; padding: 12px 16px; border-radius: 10px; border: 0; background: #0a84ff; color: #fff; }
    .hint { margin-top: 12px; font-size: 14px; color: #555; }
    pre { background:#f7f7f8; padding:10px; border-radius:8px; font-size:12px; overflow:auto; }
  </style>
</head>
<body>
  <h1>Open in RouteThis</h1>
  <p>This page tests opening the app across different browsers.</p>

  <button id="openApp">Open in App</button>
  <div class="hint" id="hint"></div>

  <h3>Debug log (for you)</h3>
  <pre id="log"></pre>
  <script>
    const params = new URLSearchParams(location.search);
    const apiKey = params.get('apiKey') || 'placeholder-api-key';
    const UL = `https://routethishelps.app.routethis.com/dl/self-install?apiKey=${encodeURIComponent(apiKey)}`;
    const SCHEME = `com.routethis.helps://self-install?apiKey=${encodeURIComponent(apiKey)}`;
    const IOS_STORE = 'itms-apps://itunes.apple.com/app/id1173976362';
    const UL_GRACE_MS = 500, FALLBACK_MS = 1600;

    const ua = navigator.userAgent||'';
    const isIOS = /iP(hone|ad|od)/i.test(ua);

    async function writeClipboardOnce() {
      try { await navigator.clipboard.writeText(UL); } catch {}
    }

    document.getElementById('openApp').addEventListener('click', () => {
      log('openApp clicked', { isIOS, ua });

      if (!isIOS) {
        log('user agent is not iOS');
        log('navigating to Universal link:', UL);
        location.href = UL; 
        return; 
      }

      let hidden = false; let cancelled = false;
      
      const onVis = () => { 
        log('visibilitychange:', document.visibilityState);
        if (document.visibilityState === 'hidden') hidden = true; 
      };

      const onHide = () => { 
        log('pagehide');
        hidden = true; 
      };

      document.addEventListener('visibilitychange', onVis, true);
      window.addEventListener('pagehide', onHide, true);

      const cleanup = (...tids) => {
        cancelled = true; tids.forEach(clearTimeout);
        document.removeEventListener('visibilitychange', onVis, true);
        window.removeEventListener('pagehide', onHide, true);
      };

      // 1) UL first
      log('navigating to Universal link:', UL);
      location.href = UL;

      // 2) Scheme if still foreground
      const t1 = setTimeout(() => {
        if (hidden || cancelled) return cleanup(t1);
        log('navigating to scheme:', SCHEME);
        location.href = SCHEME;

        // 3) Write to clipboard and open App Store if still foreground
        const t2 = setTimeout(async () => {
          if (!hidden && !cancelled) {
            await writeClipboardOnce();
            log('navigating to ap store:', IOS_STORE);
            location.href = IOS_STORE;
          }
          cleanup(t1, t2);
        }, FALLBACK_MS);
      }, UL_GRACE_MS);
    }, { passive: true });

    const logEl = document.getElementById('log');
    function log(...args) {
      const msg = args.map(x => (typeof x === 'object' ? JSON.stringify(x) : String(x))).join(' ');
      console.log('[TEST]', ...args);
      logEl.textContent += msg + '\n';
    }

  </script>
</body>
</html>